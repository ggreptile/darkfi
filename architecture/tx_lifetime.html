<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The DarkFi Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">DarkFi</a></li><li class="chapter-item expanded "><a href="../philosophy/philosophy.html"><strong aria-hidden="true">1.</strong> Philosophy</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../philosophy/ideology.html"><strong aria-hidden="true">1.1.</strong> Ideology</a></li><li class="chapter-item expanded "><a href="../philosophy/books.html"><strong aria-hidden="true">1.2.</strong> Books</a></li></ol></li><li class="chapter-item expanded "><a href="../testnet/testnet.html"><strong aria-hidden="true">2.</strong> Testnet Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../testnet/node.html"><strong aria-hidden="true">2.1.</strong> Running a Node</a></li><li class="chapter-item expanded "><a href="../testnet/airdrop.html"><strong aria-hidden="true">2.2.</strong> Airdrops</a></li><li class="chapter-item expanded "><a href="../testnet/payment.html"><strong aria-hidden="true">2.3.</strong> Payments</a></li><li class="chapter-item expanded "><a href="../testnet/atomic-swap.html"><strong aria-hidden="true">2.4.</strong> Atomic Swap</a></li><li class="chapter-item expanded "><a href="../testnet/dao.html"><strong aria-hidden="true">2.5.</strong> DAO</a></li></ol></li><li class="chapter-item expanded "><a href="../development/development.html"><strong aria-hidden="true">3.</strong> Development</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../development/contributing.html"><strong aria-hidden="true">3.1.</strong> Contributing</a></li><li class="chapter-item expanded "><a href="../development/learn.html"><strong aria-hidden="true">3.2.</strong> Learn</a></li><li class="chapter-item expanded "><a href="../development/rustdoc.html"><strong aria-hidden="true">3.3.</strong> API Rustdoc</a></li><li class="chapter-item expanded "><a href="../development/seminars.html"><strong aria-hidden="true">3.4.</strong> Seminars</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/overview.html"><strong aria-hidden="true">4.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../architecture/anonymous_assets.html"><strong aria-hidden="true">4.2.</strong> Anonymous assets</a></li><li class="chapter-item expanded "><a href="../architecture/blockchain.html"><strong aria-hidden="true">4.3.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="../architecture/consensus.html"><strong aria-hidden="true">4.4.</strong> Consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/consensus/genesis_stake.html"><strong aria-hidden="true">4.4.1.</strong> GenesisStake</a></li><li class="chapter-item expanded "><a href="../architecture/consensus/stake.html"><strong aria-hidden="true">4.4.2.</strong> Stake</a></li><li class="chapter-item expanded "><a href="../architecture/consensus/proposal.html"><strong aria-hidden="true">4.4.3.</strong> Proposal</a></li><li class="chapter-item expanded "><a href="../architecture/consensus/unstake_request.html"><strong aria-hidden="true">4.4.4.</strong> UnstakeRequest</a></li><li class="chapter-item expanded "><a href="../architecture/consensus/unstake.html"><strong aria-hidden="true">4.4.5.</strong> Unstake</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/tx_lifetime.html" class="active"><strong aria-hidden="true">4.5.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../architecture/smart_contracts.html"><strong aria-hidden="true">4.6.</strong> Smart Contracts</a></li><li class="chapter-item expanded "><a href="../architecture/bridge.html"><strong aria-hidden="true">4.7.</strong> Bridge</a></li><li class="chapter-item expanded "><a href="../architecture/tooling.html"><strong aria-hidden="true">4.8.</strong> Tooling</a></li></ol></li><li class="chapter-item expanded "><a href="../architecture/sc/sc.html"><strong aria-hidden="true">5.</strong> Smart Contracts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/sc/tx-lifetime.html"><strong aria-hidden="true">5.1.</strong> Transaction lifetime</a></li></ol></li><li class="chapter-item expanded "><a href="../zkas/index.html"><strong aria-hidden="true">6.</strong> zkas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/bincode.html"><strong aria-hidden="true">6.1.</strong> Bincode</a></li><li class="chapter-item expanded "><a href="../zkas/zkvm.html"><strong aria-hidden="true">6.2.</strong> zkVM</a></li><li class="chapter-item expanded "><a href="../zkas/examples.html"><strong aria-hidden="true">6.3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/examples/voting.html"><strong aria-hidden="true">6.3.1.</strong> Anonymous voting</a></li><li class="chapter-item expanded "><a href="../zkas/examples/sapling.html"><strong aria-hidden="true">6.3.2.</strong> Anonymous payments</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../clients/clients.html"><strong aria-hidden="true">7.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clients/darkfid_jsonrpc.html"><strong aria-hidden="true">7.1.</strong> darkfid JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../clients/faucetd_jsonrpc.html"><strong aria-hidden="true">7.2.</strong> faucetd JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../clients/anonymous_nodes.html"><strong aria-hidden="true">7.3.</strong> Anonymous Nodes</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clients/tor_inbound.html"><strong aria-hidden="true">7.3.1.</strong> Tor Inbound Node</a></li><li class="chapter-item expanded "><a href="../clients/nym_outbound.html"><strong aria-hidden="true">7.3.2.</strong> Nym Outbound Node</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../crypto/crypto.html"><strong aria-hidden="true">8.</strong> Crypto</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../crypto/fft.html"><strong aria-hidden="true">8.1.</strong> FFT</a></li><li class="chapter-item expanded "><a href="../crypto/zk_explainer.html"><strong aria-hidden="true">8.2.</strong> ZK explainer</a></li><li class="chapter-item expanded "><a href="../crypto/research.html"><strong aria-hidden="true">8.3.</strong> Research</a></li><li class="chapter-item expanded "><a href="../crypto/rln.html"><strong aria-hidden="true">8.4.</strong> Rate-Limit Nullifiers</a></li><li class="chapter-item expanded "><a href="../crypto/reading-maths-books.html"><strong aria-hidden="true">8.5.</strong> Reading maths books</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/dchat/dchat.html"><strong aria-hidden="true">9.</strong> P2P API Tutorial</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/deployment/part-1.html"><strong aria-hidden="true">9.1.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/deployment/getting-started.html"><strong aria-hidden="true">9.1.1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/writing-a-daemon.html"><strong aria-hidden="true">9.1.2.</strong> Writing a daemon</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/sessions.html"><strong aria-hidden="true">9.1.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/settings.html"><strong aria-hidden="true">9.1.4.</strong> Settings</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/error-handling.html"><strong aria-hidden="true">9.1.5.</strong> Error handling</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/start-run-stop.html"><strong aria-hidden="true">9.1.6.</strong> Start-Run-Stop</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/seed-node.html"><strong aria-hidden="true">9.1.7.</strong> Seed</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/deploy.html"><strong aria-hidden="true">9.1.8.</strong> Deploy</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/part-2.html"><strong aria-hidden="true">9.2.</strong> Creating dchat</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/message.html"><strong aria-hidden="true">9.2.1.</strong> Message</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/protocols.html"><strong aria-hidden="true">9.2.2.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/protocol-dchat.html"><strong aria-hidden="true">9.2.3.</strong> ProtocolDchat</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/register-protocol.html"><strong aria-hidden="true">9.2.4.</strong> Register protocol</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/sending-messages.html"><strong aria-hidden="true">9.2.5.</strong> Sending messages</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/ui.html"><strong aria-hidden="true">9.2.6.</strong> Slap on a UI</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/using-dchat.html"><strong aria-hidden="true">9.2.7.</strong> Using dchat</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/part-3.html"><strong aria-hidden="true">9.3.</strong> Net tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/rpc.html"><strong aria-hidden="true">9.3.1.</strong> RPC interface</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/accept-addr.html"><strong aria-hidden="true">9.3.2.</strong> Accept addr</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/pong.html"><strong aria-hidden="true">9.3.3.</strong> Adding methods</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/server.html"><strong aria-hidden="true">9.3.4.</strong> RPC server</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/get-info.html"><strong aria-hidden="true">9.3.5.</strong> get_info</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/using-dnetview.html"><strong aria-hidden="true">9.3.6.</strong> Using dnetview</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/debug.html"><strong aria-hidden="true">9.3.7.</strong> Debugging</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../misc/misc.html"><strong aria-hidden="true">10.</strong> Miscellaneous tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/vanityaddr.html"><strong aria-hidden="true">10.1.</strong> vanityaddr</a></li><li class="chapter-item expanded "><a href="../misc/ircd/ircd.html"><strong aria-hidden="true">10.2.</strong> darkirc</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/ircd/specification.html"><strong aria-hidden="true">10.2.1.</strong> Specification</a></li><li class="chapter-item expanded "><a href="../misc/ircd/private_message.html"><strong aria-hidden="true">10.2.2.</strong> Private Message</a></li></ol></li><li class="chapter-item expanded "><a href="../misc/tau.html"><strong aria-hidden="true">10.3.</strong> tau</a></li><li class="chapter-item expanded "><a href="../misc/event_graph/event_graph.html"><strong aria-hidden="true">10.4.</strong> event_graph</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/event_graph/network_protocol.html"><strong aria-hidden="true">10.4.1.</strong> Network Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../misc/darkwiki.html"><strong aria-hidden="true">10.5.</strong> darkwiki</a></li><li class="chapter-item expanded "><a href="../misc/dnetview.html"><strong aria-hidden="true">10.6.</strong> dnetview</a></li></ol></li><li class="chapter-item expanded "><a href="../zero2dark/zero2darkfi.html"><strong aria-hidden="true">11.</strong> zero2darkfi</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zero2darkfi/darkmap.html"><strong aria-hidden="true">11.1.</strong> smart contract</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <!-- Make the book title only appear if it is *not* the chapter title as well -->
                    <h1 id="book-title" class="menu-title">The DarkFi Book</h1>
                    <script type="text/javascript">
                        var bookTitleElement = document.getElementById('book-title')
                        var bookTitle = 'The DarkFi Book';
                        var chapterTitle = 'Transactions';
                        if (bookTitle === chapterTitle) {
                            bookTitleElement.innerText = null;
                            document.title = bookTitle;
                        }
                    </script>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="transactions"><a class="header" href="#transactions">Transactions</a></h1>
<p><em>(Temporary document, to be integrated into other docs)</em></p>
<h2 id="transaction-behaviour"><a class="header" href="#transaction-behaviour">Transaction behaviour</a></h2>
<p>In our network context, we have two types of nodes.</p>
<ol>
<li>Consensus Participant (<code>CP</code>)</li>
<li>Consensus Spectator (non-participant) (<code>CS</code>)</li>
</ol>
<p><code>CS</code> acts as a relayer for transactions in order to help out
that transactions reach <code>CP</code>.</p>
<p>To avoid spam attacks, <code>CS</code> should keep <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> in their mempool for some
period of time, and then prune it.</p>
<h2 id="ideal-simulation-with-instant-finality"><a class="header" href="#ideal-simulation-with-instant-finality">Ideal simulation with instant finality</a></h2>
<p>The lifetime of a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> that passes verification and whose
state transition can be applied on top of the finalized (canonical)
chain:</p>
<ol>
<li>User creates a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span></li>
<li>User broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CS</code> </li>
<li><code>CS</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CS</code> <code>mempool</code></li>
<li><code>CS</code> broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CP</code></li>
<li><code>CP</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CP</code> <code>mempool</code></li>
<li><code>CP</code> validates all transactions in its <code>mempool</code> in sequence</li>
<li><code>CP</code> proposes a block finalization containing <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span></li>
<li><code>CP</code> writes the state transition update of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to their chain</li>
<li><code>CP</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
<li><code>CP</code> broadcasts the finalized proposal</li>
<li><code>CS</code> receives the proposal and validates transactions</li>
<li><code>CS</code> writes the state updates to their chain</li>
<li><code>CS</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
</ol>
<h2 id="real-world-simulation-with-non-instant-finality"><a class="header" href="#real-world-simulation-with-non-instant-finality">Real-world simulation with non-instant finality</a></h2>
<p>The lifetime of a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> that passes verification and whose
state transition is pending to be applied on top of the finalized (canonical)
chain:</p>
<ol>
<li>User creates a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span></li>
<li>User broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CS</code></li>
<li><code>CS</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CS</code> <code>mempool</code></li>
<li><code>CS</code> broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CP</code></li>
<li><code>CP</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CP</code> <code>mempool</code></li>
<li><code>CP</code> proposes a block proposal containing <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span></li>
<li><code>CP</code> proposes more block proposals</li>
<li>When proposals can be finalized, <code>CP</code> validates all their transactions
in sequence</li>
<li><code>CP</code> writes the state transition update of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to their chain</li>
<li><code>CP</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
<li><code>CP</code> broadcasts the finalized proposals sequence</li>
<li><code>CS</code> receives the proposals sequence and validates transactions</li>
<li><code>CS</code> writes the state updates to their chain</li>
<li><code>CS</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
</ol>
<h2 id="real-world-simulation-with-non-instant-finality-forks-and-multiple-cp-nodes"><a class="header" href="#real-world-simulation-with-non-instant-finality-forks-and-multiple-cp-nodes">Real-world simulation with non-instant finality, forks and multiple <code>CP</code> nodes</a></h2>
<p>The lifetime of a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> that passes verifications and whose
state transition is pending to be applied on top of the finalized (canonical)
chain:</p>
<ol>
<li>User creates a transaction <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span></li>
<li>User broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CS</code></li>
<li><code>CS</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition against canonical chain state</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CS</code> <code>mempool</code></li>
<li><code>CS</code> broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to <code>CP</code></li>
<li><code>CP</code> validates <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> state transition against all known fork states</li>
<li><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> enters <code>CP</code> <code>mempool</code></li>
<li><code>CP</code> broadcasts <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to rest <code>CP</code> nodes</li>
<li>Slot producer <code>CP</code> (<code>SCP</code>) node finds which fork to extend</li>
<li><code>SCP</code> validates all unproposed transactions in its <code>mempool</code> in sequence,
against extended fork state, discarding invalid</li>
<li><code>SCP</code> creates a block proposal containing <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> extending the fork</li>
<li><code>CP</code> receives block proposal and validates its transactions against
the extended fork state</li>
<li><code>SCP</code> proposes more block proposals extending a fork state</li>
<li>When a fork can be finalized, <code>CP</code> validates all its proposals
transactions in sequence, against canonical state</li>
<li><code>CP</code> writes the state transition update of <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> to their chain</li>
<li><code>CP</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
<li><code>CP</code> drop rest forks and keeps only the finalized one</li>
<li><code>CP</code> broadcasts the finalized proposals sequence</li>
<li><code>CS</code> receives the proposals sequence and validates transactions</li>
<li><code>CS</code> writes the state updates to their chain</li>
<li><code>CS</code> removes <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> from their <code>mempool</code></li>
</ol>
<p><code>CP</code> will keep <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> in its <code>mempool</code> as long as it is a valid state transition
for any fork(including canonical) or it get finalized.</p>
<p>Unproposed transactions refers to all <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">x</span></span></span></span> not included in a proposal of any fork.</p>
<p>If a fork that can be finalized fails to validate all its transactions(14), it should be dropped.</p>
<h2 id="the-transaction-object"><a class="header" href="#the-transaction-object">The <code>Transaction</code> object</a></h2>
<pre><code class="language-rust">pub struct ContractCall {
    /// The contract ID to which the payload is fed to
    pub contract_id: ContractId,
    /// Arbitrary payload for the contract call
    pub payload: Vec&lt;u8&gt;,
}

pub struct Transaction {
    /// Calls executed in this transaction
    pub calls: Vec&lt;ContractCall&gt;,
    /// Attached ZK proofs
    pub proofs: Vec&lt;Vec&lt;Proof&gt;&gt;,
    /// Attached Schnorr signatures
    pub signatures: Vec&lt;Vec&lt;Signature&gt;&gt;,
}</code></pre>
<p>A generic DarkFi transaction object is simply an array of smart
contract calls, along with attached ZK proofs and signatures needed
to properly verify the contracts' execution. A transaction can have
any number of calls, and proofs, provided it does not exhaust a set
gas limit.</p>
<p>In DarkFi, every operation is a smart contract. This includes payments,
which we'll explain in the following section.</p>
<h2 id="payments"><a class="header" href="#payments">Payments</a></h2>
<p>For A -&gt; B payments in DarkFi we use the Sapling scheme that originates
from zcash. A payment transaction has a number of <em>inputs</em> (which are
coins being burned/spent), and a number of <em>outputs</em> (which are coins
being minted/created). An explanation for the ZK proofs for this scheme
can be found in the Zkas section of this book, under Sapling.</p>
<p>In code, the structs we use are the following:</p>
<pre><code class="language-rust">pub struct MoneyTransferParams {
    pub inputs: Vec&lt;Input&gt;,
    pub outputs: Vec&lt;Output&gt;,
}

pub struct Input {
    /// Pedersen commitment for the input's value
    pub value_commit: ValueCommit,
    /// Pedersen commitment for the input's token ID
    pub token_commit: ValueCommit,
    /// Revealed nullifier
    pub nullifier: Nullifier,
    /// Revealed Merkle root
    pub merkle_root: MerkleNode,
    /// Public key for the Schnorr signature
    pub signature_public: PublicKey,
}

pub struct Output {
    /// Pedersen commitment for the output's value
    pub value_commit: ValueCommit,
    /// Pedersen commitment for the output's token ID
    pub token_commit: ValueCommit,
    /// Minted coin: poseidon_hash(pubkey, value, token, serial, blind)
    pub coin: Coin,
    /// The encrypted note ciphertext
    pub encrypted_note: EncryptedNote,
}

pub struct EncryptedNote {
    pub ciphertext: Vec&lt;u8&gt;,
    pub ephemeral_key: PublicKey,
}

pub struct Note {
    /// Serial number of the coin, used to derive the nullifier
    pub serial: pallas::Base,
    /// Value of the coin
    pub value: u64,
    /// Token ID of the coin
    pub token_id: TokenId,
    /// Blinding factor for the value Pedersen commitment
    pub value_blind: ValueBlind,
    /// Blinding factor for the token ID Pedersen commitment
    pub token_blind: ValueBlind,
    /// Attached memo (arbitrary data)
    pub memo: Vec&lt;u8&gt;,
}</code></pre>
<p>In the blockchain state, every minted coin must be added into a Merkle
tree of all existing coins. Once added, the new tree root is used to
prove existence of this coin when it's being spent.</p>
<p>Let's imagine a scenario where Alice has 100 ALICE tokens and wants to
send them to Bob. Alice would create an <code>Input</code> object using the info
she has of her coin. She has to derive a <code>nullifier</code> given her secret
key and the serial number of the coin, hash the coin bulla so she can
create a merkle path proof, and derive the value and token commitments
using the blinds.</p>
<pre><code class="language-rust">let nullifier = poseidon_hash([alice_secret_key, serial]);
let signature_public = alice_secret_key * Generator;
let coin = poseidon_hash([signature_public, value, token_id, blind]);
let merkle_root = calculate_merkle_root(coin);
let value_commit = pedersen_commitment(value, value_blind);
let token_commit = pedersen_commitment(token_id, token_blind);</code></pre>
<p>The values above, except <code>coin</code> become the public inputs for the <code>Burn</code>
ZK proof. If everything is correct, this allows Alice to spend her coin.
In DarkFi, the changes have to be atomic, so any payment transaction
that is burning some coins, has to mint new coins at the same time, and
no value must be lost, nor can the token ID change. We enforce this by
using Pedersen commitments.</p>
<p>Now that Alice has a valid <code>Burn</code> proof and can spend her coin, she can
mint a new coin for Bob.</p>
<pre><code class="language-rust">let blind = pallas::Base::random();
let value_blind = ValueBlind::random();
let token_blind = ValueBlind::random();
let coin = poseidon_hash([bob_public, value, token_id, blind]);
let value_commit = pedersen_commitment(value, value_blind);
let token_commit = pedersen_commitment(token, token_blind);</code></pre>
<p><code>coin</code>, <code>value_commit</code>, and <code>token_commit</code> become the public inputs
for the <code>Mint</code> ZK proof. If this proof is valid, it creates a new coin
for Bob with the given parameters. Additionally, Alice would put the
values and blinds in a <code>Note</code> which is encrypted with Bob's public key
so only Bob is able to decrypt it. This <code>Note</code> has the necessary info
for him to further spend the coin he received.</p>
<p>At this point Alice should have 1 input and 1 output. The input is the
coin she burned, and the output is the coin she minted for Bob. Along
with this, she has two ZK proofs that prove creation of the input and
output. Now she can build a transaction object, and then use her secret
key she derived in the <code>Burn</code> proof to sign the transaction and publish
it to the blockchain.</p>
<p>The blockchain will execute the smart contract with the given payload
and verify that the Pedersen commitments match, that the nullifier has
not been published before, and also that the merkle authentication path
is valid and therefore the coin existed in a previous state. Outside of
the VM, the validator will also verify the signature(s) and the ZK
proofs. If this is valid, then Alice's coin is now burned and cannot be
used anymore. And since Alice also created an output for Bob, this new
coin is now added to the Merkle tree and is able to be spent by him.
Effectively this means that Alice has sent her tokens to Bob.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture/consensus/unstake.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../architecture/smart_contracts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture/consensus/unstake.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../architecture/smart_contracts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../theme/mermaid.min.js"></script>
        <script type="text/javascript" src="../theme/mermaid-init.js"></script>


    </body>
</html>
